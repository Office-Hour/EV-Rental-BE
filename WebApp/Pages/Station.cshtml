@page "{id:guid}"
@model WebApp.Pages.StationModel
@{
    ViewData["Title"] = Model.Station?.Name ?? "Chi Tiết Trạm";
}

<link rel="stylesheet" href="~/css/Index.css" />
<link rel="stylesheet" href="~/css/station.css" asp-append-version="true" />

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show m-4" role="alert">
        <span class="material-icons">error</span>
        @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (Model.Station != null)
{
    <!-- Hero Section with Station Info -->
    <section class="hero-section hero-gradient">
        <div class="container" style="max-width: 72rem;">
            <div class="hero-content">
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb-custom">
                        <li class="breadcrumb-item">
                            <a asp-page="/Index" class="breadcrumb-link">
                                <span class="material-icons">home</span>
                                Trang chủ
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a asp-page="/Stations" class="breadcrumb-link">
                                <span class="material-icons">ev_station</span>
                                Trạm xe điện
                            </a>
                        </li>
                        <li class="breadcrumb-item active">@Model.Station.Name</li>
                    </ol>
                </nav>

                <!-- Station Header Card -->
                <div class="station-header-card">
                    <div class="station-header-content">
                        <div class="station-icon-large">
                            <span class="material-icons">ev_station</span>
                        </div>
                        <div class="station-header-info">
                            <h1 class="station-title">@Model.Station.Name</h1>
                            <p class="station-address-large">
                                <span class="material-icons">location_on</span>
                                @Model.Station.Address
                            </p>
                            <div class="station-stats">
                                <div class="stat-badge">
                                    <span class="material-icons">electric_car</span>
                                    <span>@Model.AvailableVehicles?.Total xe khả dụng</span>
                                </div>
                                <div class="stat-badge">
                                    <span class="material-icons">verified</span>
                                    <span>Đã xác minh</span>
                                </div>
                            </div>
                        </div>
                        <div class="station-header-actions">
                            <a href="https://www.google.com/maps/search/?api=1&query=@Model.Station.Address" 
                               target="_blank" 
                               class="btn btn-outline-light btn-lg">
                                <span class="material-icons">directions</span>
                                Chỉ Đường
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Time Filter Form -->
                <form method="get" class="filter-form">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="row g-3">
                        <div class="col-md-5">
                            <div class="filter-input-group">
                                <label class="filter-label">
                                    <span class="material-icons">event</span>
                                    Thời gian bắt đầu
                                </label>
                                <input type="datetime-local" 
                                       name="StartTime" 
                                       value="@Model.StartTime?.ToString("yyyy-MM-ddTHH:mm")" 
                                       class="form-control filter-input" />
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="filter-input-group">
                                <label class="filter-label">
                                    <span class="material-icons">event</span>
                                    Thời gian kết thúc
                                </label>
                                <input type="datetime-local" 
                                       name="EndTime" 
                                       value="@Model.EndTime?.ToString("yyyy-MM-ddTHH:mm")" 
                                       class="form-control filter-input" />
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-gradient w-100">
                                <span class="material-icons">search</span>
                                Lọc
                            </button>
                        </div>
                    </div>
                    @if (Model.StartTime.HasValue || Model.EndTime.HasValue)
                    {
                        <div class="mt-3 text-center">
                            <a asp-page="/Station" asp-route-id="@Model.Id" class="btn btn-outline-slate btn-sm">
                                <span class="material-icons" style="font-size: 1rem;">clear</span>
                                Xóa Bộ Lọc
                            </a>
                        </div>
                    }
                </form>
            </div>
        </div>
    </section>

    <!-- Available Vehicles Section -->
    <section class="py-5 bg-slate-50">
        <div class="container" style="max-width: 72rem;">
            @if (Model.AvailableVehicles?.Items?.Any() == true)
            {
                <!-- Results Header -->
                <div class="results-header mb-4">
                    <h2 class="fw-bold text-slate-800 mb-2">
                        @Model.AvailableVehicles.Total xe khả dụng
                    </h2>
                    <p class="text-slate-600">
                        @if (Model.StartTime.HasValue && Model.EndTime.HasValue)
                        {
                            <span>
                                Từ @Model.StartTime.Value.ToString("dd/MM/yyyy HH:mm") 
                                đến @Model.EndTime.Value.ToString("dd/MM/yyyy HH:mm")
                            </span>
                        }
                        else if (Model.StartTime.HasValue)
                        {
                            <span>Từ @Model.StartTime.Value.ToString("dd/MM/yyyy HH:mm")</span>
                        }
                        else if (Model.EndTime.HasValue)
                        {
                            <span>Đến @Model.EndTime.Value.ToString("dd/MM/yyyy HH:mm")</span>
                        }
                        else
                        {
                            <span>Tất cả xe hiện có</span>
                        }
                    </p>
                </div>

                <!-- Vehicles Grid -->
                <div class="row g-4 mb-5">
                    @foreach (var vehicle in Model.AvailableVehicles.Items)
                    {
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="vehicle-card">
                                <div class="vehicle-card-header">
                                    <div class="vehicle-status-badge status-@vehicle.Status.ToString().ToLower()">
                                        <span class="material-icons">bolt</span>
                                        <span>@vehicle.Status</span>
                                    </div>
                                </div>

                                <div class="vehicle-card-body">
                                    <div class="vehicle-icon">
                                        <span class="material-icons">electric_car</span>
                                    </div>

                                    <h3 class="vehicle-name">ID: @vehicle.VehicleId.ToString().Substring(0, 8).ToUpper()</h3>

                                    <div class="vehicle-specs">
                                        <div class="spec-item">
                                            <span class="material-icons">battery_charging_full</span>
                                            <div>
                                                <strong>@vehicle.CurrentBatteryCapacityKwh kWh</strong>
                                                <small>Dung lượng pin</small>
                                            </div>
                                        </div>

                                        <div class="spec-item">
                                            <span class="material-icons">schedule</span>
                                            <div>
                                                <strong>@vehicle.StartTime.ToString("dd/MM/yyyy")</strong>
                                                <small>Có sẵn từ</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="vehicle-card-footer">
                                    <a asp-area="Renter"
                                       asp-page="/Booking/Create" 
                                       asp-route-vehicleAtStationId="@vehicle.VehicleAtStationId"
                                       asp-route-startTime="@Model.StartTime"
                                       asp-route-endTime="@Model.EndTime"
                                       class="btn btn-primary btn-sm">
                                        <span class="material-icons">event</span>
                                        Đặt Xe
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Pagination -->
                @if (Model.AvailableVehicles.Total > Model.PageSize)
                {
                    <nav aria-label="Vehicle pagination">
                        <ul class="pagination justify-content-center">
                            <!-- Previous Button -->
                            <li class="page-item @(Model.PageNumber <= 1 ? "disabled" : "")">
                                <a class="page-link" 
                                   asp-page="/Station" 
                                   asp-route-id="@Model.Id"
                                   asp-route-pageNumber="@(Model.PageNumber - 1)"
                                   asp-route-pageSize="@Model.PageSize"
                                   asp-route-startTime="@Model.StartTime"
                                   asp-route-endTime="@Model.EndTime">
                                    <span class="material-icons">chevron_left</span>
                                </a>
                            </li>

                            @{
                                var totalPages = (int)Math.Ceiling((double)Model.AvailableVehicles.Total / Model.PageSize);
                                var startPage = Math.Max(1, Model.PageNumber - 2);
                                var endPage = Math.Min(totalPages, Model.PageNumber + 2);
                            }

                            @if (startPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" 
                                       asp-page="/Station" 
                                       asp-route-id="@Model.Id"
                                       asp-route-pageNumber="1"
                                       asp-route-pageSize="@Model.PageSize"
                                       asp-route-startTime="@Model.StartTime"
                                       asp-route-endTime="@Model.EndTime">
                                        1
                                    </a>
                                </li>
                                @if (startPage > 2)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                            }

                            @for (var i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                    <a class="page-link" 
                                       asp-page="/Station" 
                                       asp-route-id="@Model.Id"
                                       asp-route-pageNumber="@i"
                                       asp-route-pageSize="@Model.PageSize"
                                       asp-route-startTime="@Model.StartTime"
                                       asp-route-endTime="@Model.EndTime">
                                        @i
                                    </a>
                                </li>
                            }

                            @if (endPage < totalPages)
                            {
                                @if (endPage < totalPages - 1)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                                <li class="page-item">
                                    <a class="page-link" 
                                       asp-page="/Station" 
                                       asp-route-id="@Model.Id"
                                       asp-route-pageNumber="@totalPages"
                                       asp-route-pageSize="@Model.PageSize"
                                       asp-route-startTime="@Model.StartTime"
                                       asp-route-endTime="@Model.EndTime">
                                        @totalPages
                                    </a>
                                </li>
                            }

                            <!-- Next Button -->
                            <li class="page-item @(Model.PageNumber >= totalPages ? "disabled" : "")">
                                <a class="page-link" 
                                   asp-page="/Station" 
                                   asp-route-id="@Model.Id"
                                   asp-route-pageNumber="@(Model.PageNumber + 1)"
                                   asp-route-pageSize="@Model.PageSize"
                                   asp-route-startTime="@Model.StartTime"
                                   asp-route-endTime="@Model.EndTime">
                                    <span class="material-icons">chevron_right</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                }
            }
            else
            {
                <!-- Empty State -->
                <div class="empty-state-section">
                    <div class="empty-state-icon">
                        <span class="material-icons">electric_car_off</span>
                    </div>
                    <h3 class="empty-state-title">Không có xe khả dụng</h3>
                    <p class="empty-state-description">
                        @if (Model.StartTime.HasValue || Model.EndTime.HasValue)
                        {
                            <span>Không có xe nào khả dụng trong khoảng thời gian này. Vui lòng thử lại với thời gian khác.</span>
                        }
                        else
                        {
                            <span>Hiện tại trạm này không có xe nào khả dụng. Vui lòng quay lại sau.</span>
                        }
                    </p>
                    @if (Model.StartTime.HasValue || Model.EndTime.HasValue)
                    {
                        <a asp-page="/Station" asp-route-id="@Model.Id" class="btn btn-gradient mt-3">
                            <span class="material-icons">refresh</span>
                            Xem Tất Cả Xe
                        </a>
                    }
                    else
                    {
                        <a asp-page="/Stations" class="btn btn-gradient mt-3">
                            <span class="material-icons">ev_station</span>
                            Xem Trạm Khác
                        </a>
                    }
                </div>
            }
        </div>
    </section>

    <!-- Why Choose Section -->
    <section class="py-5 bg-white">
        <div class="container" style="max-width: 72rem;">
            <div class="text-center mb-5">
                <h2 class="fw-bold text-slate-800 mb-3 fs-2">Quy Trình Thuê Xe</h2>
                <p class="text-slate-600 fs-5 mx-auto" style="max-width: 42rem;">
                    Đơn giản và nhanh chóng với Voltera
                </p>
            </div>

            <div class="row g-4">
                <!-- Step 1 -->
                <div class="col-12 col-md-4">
                    <div class="process-card">
                        <div class="process-number">1</div>
                        <div class="process-icon bg-emerald-100">
                            <span class="material-icons text-emerald-600">event</span>
                        </div>
                        <h3 class="process-title">Chọn Thời Gian</h3>
                        <p class="process-description">Chọn thời gian bắt đầu và kết thúc thuê xe phù hợp với kế hoạch của bạn</p>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="col-12 col-md-4">
                    <div class="process-card">
                        <div class="process-number">2</div>
                        <div class="process-icon bg-blue-100">
                            <span class="material-icons text-blue-600">electric_car</span>
                        </div>
                        <h3 class="process-title">Chọn Xe</h3>
                        <p class="process-description">Chọn xe điện phù hợp từ danh sách xe khả dụng tại trạm</p>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="col-12 col-md-4">
                    <div class="process-card">
                        <div class="process-number">3</div>
                        <div class="process-icon bg-purple-100">
                            <span class="material-icons text-purple-600">check_circle</span>
                        </div>
                        <h3 class="process-title">Xác Nhận & Thanh Toán</h3>
                        <p class="process-description">Xác nhận đặt xe và hoàn tất thanh toán để bắt đầu hành trình</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="py-5 cta-gradient">
        <div class="container" style="max-width: 48rem;">
            <div class="text-center px-3">
                <h2 class="fw-bold text-white mb-3 fs-2">Cần Hỗ Trợ?</h2>
                <p class="fs-5 text-emerald-100 mb-4">
                    Đội ngũ của chúng tôi luôn sẵn sàng hỗ trợ bạn 24/7
                </p>
                <div class="d-flex gap-3 justify-content-center flex-wrap">
                    <a href="tel:1900xxxx" class="btn bg-white text-emerald-600 fw-semibold rounded-pill px-4 py-3 hover-scale shadow-lg">
                        <span class="material-icons" style="vertical-align: middle;">phone</span>
                        Gọi Hotline
                    </a>
                    <a asp-page="/Stations" class="btn btn-outline-light rounded-pill px-4 py-3">
                        <span class="material-icons" style="vertical-align: middle;">ev_station</span>
                        Xem Trạm Khác
                    </a>
                </div>
            </div>
        </div>
    </section>
}
else
{
    <!-- Station Not Found -->
    <section class="min-vh-100 d-flex align-items-center justify-content-center bg-slate-50">
        <div class="container" style="max-width: 48rem;">
            <div class="empty-state-section">
                <div class="empty-state-icon">
                    <span class="material-icons">location_off</span>
                </div>
                <h3 class="empty-state-title">Không Tìm Thấy Trạm</h3>
                <p class="empty-state-description">
                    Trạm bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.
                </p>
                <a asp-page="/Stations" class="btn btn-gradient mt-3">
                    <span class="material-icons">ev_station</span>
                    Xem Tất Cả Trạm
                </a>
            </div>
        </div>
    </section>
}
